<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Notes on learning Open Data Cube"><title>Datacube Function Note</title><link rel=canonical href=https://www.hugoshih.com/p/datacube-function-note/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="Datacube Function Note"><meta property='og:description' content="Notes on learning Open Data Cube"><meta property='og:url' content='https://www.hugoshih.com/p/datacube-function-note/'><meta property='og:site_name' content='Hsing-Yu Shih'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Datacube'><meta property='article:published_time' content='2019-03-22T00:58:25+08:00'><meta property='article:modified_time' content='2019-03-22T00:58:25+08:00'><meta property='og:image' content='https://miro.medium.com/max/1400/0*dq7FvX_09B4zw8ZO'><meta name=twitter:title content="Datacube Function Note"><meta name=twitter:description content="Notes on learning Open Data Cube"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://miro.medium.com/max/1400/0*dq7FvX_09B4zw8ZO'><link rel="shortcut icon" href=/img/favicon.png><script async src="https://www.googletagmanager.com/gtag/js?id=G-6PQF6N4WXG"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6PQF6N4WXG")}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.setItem(e,"dark")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_819cc45341d19fd1.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Hsing-Yu Shih</a></h1><h2 class=site-description>Embedded Systems Engineer
| Chase excellence, success will follow you.</h2></div></header><ol class=menu-social><li><a href=https://github.com/h920032 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/hugoshih/ target=_blank title=Linkedin rel=me><svg class="icon icon-tabler icon-tabler-brand-linkedin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><desc>Download more icon variants from https://tabler-icons.io/i/brand-linkedin</desc><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="4" width="16" height="16" rx="2"/><line x1="8" y1="11" x2="8" y2="16"/><line x1="8" y1="8" x2="8" y2="8.01"/><line x1="12" y1="16" x2="12" y2="11"/><path d="M16 16v-3a2 2 0 00-4 0"/></svg></a></li><li><a href=https://orcid.org/0000-0003-4111-3768 target=_blank title=Research rel=me><svg class="icon icon-tabler icon-tabler-school" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><desc>Download more icon variants from https://tabler-icons.io/i/school</desc><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 9 12 5 2 9l10 4 10-4v6"/><path d="M6 10.6V16a6 3 0 0012 0v-5.4"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://www.hugoshih.com/ selected>English</option><option value=https://www.hugoshih.com/zh-cn/>中文</option></select></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#api-functions>API Functions</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/datacube-function-note/><img src=https://miro.medium.com/max/1400/0*dq7FvX_09B4zw8ZO loading=lazy alt="Featured image of post Datacube Function Note"></a></div><div class=article-details><header class=article-category><a href=/categories/uncategorized/>Uncategorized</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/datacube-function-note/>Datacube Function Note</a></h2><h3 class=article-subtitle>Notes on learning Open Data Cube</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2019-03-22T00:58:25+08:00>Mar 22, 2019</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>13 minute read</time></div></footer></div></header><section class=article-content><h1 id=datacube-function-note---basic>Datacube Function Note - Basic</h1><h2 id=api-functions>API Functions</h2><p>Can refer to this website: <a class=link href=https://nbviewer.jupyter.org/github/opendatacube/datacube-core/blob/develop/examples/notebooks/Datacube_Summary.ipynb target=_blank rel=noopener>https://nbviewer.jupyter.org/github/opendatacube/datacube-core/blob/develop/examples/notebooks/Datacube_Summary.ipynb</a>
Official function documentation: <a class=link href=https://datacube-core.readthedocs.io/en/latest/_modules/index.html target=_blank rel=noopener>https://datacube-core.readthedocs.io/en/latest/_modules/index.html</a>
Adjusting image colors: <a class=link href=http://xarray.pydata.org/en/stable/plotting.html target=_blank rel=noopener>http://xarray.pydata.org/en/stable/plotting.html</a>
Example package: <a class=link href=https://nbviewer.jupyter.org/github/opendatacube/datacube-core/tree/develop/examples/notebooks/ target=_blank rel=noopener>https://nbviewer.jupyter.org/github/opendatacube/datacube-core/tree/develop/examples/notebooks/</a>
xarray usage: <a class=link href=https://xarray.pydata.org/en/stable/generated/xarray.Dataset.html#xarray.Dataset target=_blank rel=noopener>https://xarray.pydata.org/en/stable/generated/xarray.Dataset.html#xarray.Dataset</a>
<a class=link href=https://xarray.pydata.org/en/stable/api.html#dataarray target=_blank rel=noopener>https://xarray.pydata.org/en/stable/api.html#dataarray</a></p><ol><li>Datacube class: create a Datacube item, used when importing Datacube database</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=k>class</span> <span class=nc>datacube</span><span class=o>.</span><span class=n>Datacube</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>config</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>app</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> 
</span></span><span class=line><span class=cl><span class=n>env</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>validate_connection</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Example:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>datacube</span>
</span></span><span class=line><span class=cl><span class=n>dc</span> <span class=o>=</span> <span class=n>datacube</span><span class=o>.</span><span class=n>Datacube</span><span class=p>(</span><span class=n>app</span> <span class=o>=</span> <span class=s1>&#39;my_app&#39;</span><span class=p>,</span> <span class=n>config</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl><span class=s1>&#39;/home/localuser/.datacube.conf&#39;</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=c1># Basically look at where the data is in the Datacube you use, suggest using directly</span>
</span></span></code></pre></td></tr></table></div></div><ol><li>Datacube.list_products() & Datacube.list_measurements()</li></ol><ul><li><strong>Datacube.list_products()</strong>: list all satellite data</li><li><strong>Datacube.list_measurements()</strong>: list band types contained in satellite data</li></ul><p>Example:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>list_of_products</span> <span class=o>=</span> <span class=n>dc</span><span class=o>.</span><span class=n>list_products</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>netCDF_products</span> <span class=o>=</span> <span class=n>list_of_products</span><span class=p>[</span><span class=n>list_of_products</span><span class=p>[</span><span class=s1>&#39;format&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;NetCDF&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>netCDF_products</span>
</span></span><span class=line><span class=cl><span class=c1># Set list_of_products parameters as above, I don&#39;t know the difference either</span>
</span></span><span class=line><span class=cl><span class=c1># Prints out a table</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>list_of_measurements</span> <span class=o>=</span> <span class=n>dc</span><span class=o>.</span><span class=n>list_measurements</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>list_of_measurements</span>
</span></span><span class=line><span class=cl><span class=c1># Can print directly, prints out a table too</span>
</span></span></code></pre></td></tr></table></div></div><ol start=2><li>Datacube.load(): Create an xarray.Dataset to store various parameters of data to be fetched</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>Datacube</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>product</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span> <span class=n>measurements</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span> <span class=n>output_crs</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span> 
</span></span><span class=line><span class=cl><span class=n>resolution</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span> <span class=n>resampling</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span> <span class=n>dask_chunks</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span> 
</span></span><span class=line><span class=cl><span class=n>like</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span> <span class=n>fuse_func</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span> <span class=n>align</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span> 
</span></span><span class=line><span class=cl><span class=n>datasets</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span> <span class=o>**</span><span class=n>query</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Example 1:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>datetime</span>
</span></span><span class=line><span class=cl><span class=c1># define geographic boundaries in (min, max) format</span>
</span></span><span class=line><span class=cl><span class=c1># Use two variables to store latitude and longitude range (box) to find, I don&#39;t know how to use polygon</span>
</span></span><span class=line><span class=cl><span class=n>lon</span> <span class=o>=</span> <span class=p>(</span><span class=mf>120.3697</span><span class=p>,</span> <span class=mf>120.5044</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>lat</span> <span class=o>=</span> <span class=p>(</span><span class=mf>23.6686</span><span class=p>,</span> <span class=mf>23.7476</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># define date range boundaries in (min,max) format</span>
</span></span><span class=line><span class=cl><span class=c1># Use datetime format to store time range for extracting data</span>
</span></span><span class=line><span class=cl><span class=n>date_range</span> <span class=o>=</span><span class=p>(</span><span class=n>datetime</span><span class=o>.</span><span class=n>datetime</span><span class=p>(</span><span class=mi>2016</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> 
</span></span><span class=line><span class=cl><span class=n>datetime</span><span class=o>.</span><span class=n>datetime</span><span class=p>(</span><span class=mi>2017</span><span class=p>,</span><span class=mi>6</span><span class=p>,</span><span class=mi>30</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># define product and platform to specify our intent to </span>
</span></span><span class=line><span class=cl><span class=c1>#load Landsat 8 sr products</span>
</span></span><span class=line><span class=cl><span class=n>platform</span> <span class=o>=</span> <span class=s1>&#39;LANDSAT_8&#39;</span> 
</span></span><span class=line><span class=cl><span class=c1># Satellite data template, actually no need to type, if type don&#39;t make mistake</span>
</span></span><span class=line><span class=cl><span class=n>product</span> <span class=o>=</span> <span class=s1>&#39;ls8_lasrc_taiwan&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># Used to identify which satellite data to read, absolutely cannot make mistake</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># define desired bands. </span>
</span></span><span class=line><span class=cl><span class=n>desired_bands</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;red&#39;</span><span class=p>,</span><span class=s1>&#39;green&#39;</span><span class=p>,</span><span class=s1>&#39;blue&#39;</span><span class=p>,</span><span class=s1>&#39;nir&#39;</span><span class=p>,</span><span class=s1>&#39;swir1&#39;</span><span class=p>,</span><span class=s1>&#39;swir2&#39;</span><span class=p>,</span><span class=s1>&#39;pixel_qa&#39;</span><span class=p>]</span>  
</span></span><span class=line><span class=cl><span class=c1># Band data to extract</span>
</span></span><span class=line><span class=cl><span class=c1># For Landsat8 there are coastal_aerosol, blue, green, red, nir, swir1, swir2,</span>
</span></span><span class=line><span class=cl><span class=c1># lwir1, lwir2, pixel_qa, sr_aerosol, radsat_qa bands, we only extracted some of them, can add more</span>
</span></span><span class=line><span class=cl><span class=c1># Output order will appear according to arrangement in array</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># load area. Should result in approximately 15 </span>
</span></span><span class=line><span class=cl><span class=c1>#acquisitions between 2014 and 2016      </span>
</span></span><span class=line><span class=cl><span class=n>landsat</span> <span class=o>=</span> <span class=n>dc</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>product</span> <span class=o>=</span> <span class=n>product</span><span class=p>,</span><span class=n>platform</span> <span class=o>=</span> <span class=n>platform</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>lat</span> <span class=o>=</span> <span class=n>lat</span><span class=p>,</span><span class=n>lon</span> <span class=o>=</span> <span class=n>lon</span><span class=p>,</span><span class=n>time</span> <span class=o>=</span> <span class=n>date_range</span><span class=p>,</span> 
</span></span><span class=line><span class=cl><span class=n>measurements</span> <span class=o>=</span> <span class=n>desired_bands</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>landsat</span>
</span></span><span class=line><span class=cl><span class=c1># Then actually load data out, returned format is xarray.Dataset</span>
</span></span></code></pre></td></tr></table></div></div><p>Example 2:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>dc</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>product</span><span class=o>=</span><span class=s1>&#39;ls5_nbar_albers&#39;</span><span class=p>,</span> <span class=n>x</span><span class=o>=</span><span class=p>(</span><span class=mf>148.15</span><span class=p>,</span> <span class=mf>148.2</span><span class=p>),</span> <span class=n>y</span><span class=o>=</span><span class=p>(</span><span class=o>-</span><span class=mf>35.15</span><span class=p>,</span> <span class=o>-</span><span class=mf>35.2</span><span class=p>),</span> <span class=n>time</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;1990&#39;</span><span class=p>,</span> <span class=s1>&#39;1991&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=c1># Time coordinates etc. can use this notation above</span>
</span></span><span class=line><span class=cl><span class=n>x</span><span class=o>=</span><span class=p>(</span><span class=mi>1516200</span><span class=p>,</span> <span class=mi>1541300</span><span class=p>),</span> <span class=n>y</span><span class=o>=</span><span class=p>(</span><span class=o>-</span><span class=mi>3867375</span><span class=p>,</span> <span class=o>-</span><span class=mi>3867350</span><span class=p>),</span> <span class=n>crs</span><span class=o>=</span><span class=s1>&#39;EPSG:3577&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># Can also do this, just need to note crs</span>
</span></span><span class=line><span class=cl><span class=c1># Time can also use method above</span>
</span></span><span class=line><span class=cl><span class=n>output_crs</span><span class=o>=</span><span class=s1>&#39;EPSG:3577`, resolution=(-25, 25), resampling=&#39;</span><span class=n>cubic</span><span class=s1>&#39;)</span>
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>Datacube.find_datasets(), Datacube.group_datasets(), Datacube.load_data()</li></ol><ul><li><strong>Datacube.find_datasets()</strong>: list image data locations meeting conditions, return as list</li><li><strong>Datacube.group_datasets()</strong>: group data in list returned by find_datasets() above, can also make a file path list meeting format yourself, then it can also help you group</li><li><strong>Datacube.load_data()</strong>: load data grouped just now</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>Datacube</span><span class=o>.</span><span class=n>find_datasets</span><span class=p>(</span><span class=o>**</span><span class=n>search_terms</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Parameter part needs to input a special Query type, but datacube is weird, cannot import this format</span>
</span></span><span class=line><span class=cl><span class=c1># So example later has way to directly input parameters</span>
</span></span><span class=line><span class=cl><span class=n>Datacube</span><span class=o>.</span><span class=n>group_datasets</span><span class=p>(</span><span class=n>datasets</span><span class=p>,</span> <span class=n>group_by</span><span class=p>)</span> <span class=c1># Gave up trying this function XD mainly don&#39;t know what to fill for group_by parameter</span>
</span></span><span class=line><span class=cl><span class=c1># Just pass in thing returned by find_datasets above</span>
</span></span><span class=line><span class=cl><span class=c1># Will return xarray.DataArray format seen previously</span>
</span></span><span class=line><span class=cl><span class=n>Datacube</span><span class=o>.</span><span class=n>load_data</span><span class=p>(</span><span class=n>sources</span><span class=p>,</span> <span class=n>geobox</span><span class=p>,</span> <span class=n>measurements</span><span class=p>,</span> <span class=n>resampling</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>fuse_func</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>dask_chunks</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>skip_broken_datasets</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Also gave up trying this function XD</span>
</span></span><span class=line><span class=cl><span class=c1># Pass in xarray grouped just now, then pass out xarray.Dataset</span>
</span></span></code></pre></td></tr></table></div></div><p>Example:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>dc</span><span class=o>.</span><span class=n>find_datasets</span><span class=p>(</span><span class=n>product</span> <span class=o>=</span> <span class=s1>&#39;ls8_lasrc_taiwan&#39;</span><span class=p>,</span> <span class=n>time</span> <span class=o>=</span> <span class=p>(</span><span class=s1>&#39;2016-01-01&#39;</span><span class=p>,</span> <span class=s1>&#39;2017-01-01&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># Then will return a list, containing locations of all data meeting conditions</span>
</span></span></code></pre></td></tr></table></div></div><ol start=4><li>Add crs data
Actually this step can be skipped, basically integrating read parameters</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>xarray</span> <span class=k>as</span> <span class=nn>xr</span>  
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=c1># xarray is format used to store read data</span>
</span></span><span class=line><span class=cl><span class=n>combined_dataset</span> <span class=o>=</span> <span class=n>xr</span><span class=o>.</span><span class=n>merge</span><span class=p>([</span><span class=n>landsat</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=c1># Copy original crs to merged dataset </span>
</span></span><span class=line><span class=cl><span class=n>combined_dataset</span> <span class=o>=</span> <span class=n>combined_dataset</span><span class=o>.</span><span class=n>assign_attrs</span><span class=p>(</span><span class=n>landsat</span><span class=o>.</span><span class=n>attrs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>combined_dataset</span>
</span></span></code></pre></td></tr></table></div></div><ol start=5><li>Actually fetch data</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span> <span class=c1># Contains function to convert time to string</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>rasterio</span> <span class=c1># Convert point data to tiles</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dc_utilities</span> <span class=kn>import</span> <span class=n>write_geotiff_from_xr</span> <span class=c1># This is quite important, can convert xr format to geotiff format</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>time_to_string</span><span class=p>(</span><span class=n>t</span><span class=p>):</span> <span class=c1># Convert time to string</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=n>time</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&#34;%Y_%m_</span><span class=si>%d</span><span class=s2>_%H_%M_%S&#34;</span><span class=p>,</span> <span class=n>time</span><span class=o>.</span><span class=n>gmtime</span><span class=p>(</span><span class=n>t</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span><span class=o>/</span><span class=mi>1000000000</span><span class=p>))</span>
</span></span><span class=line><span class=cl>   <span class=c1># Just use `time.strftime` function to convert time to string, used to add to filename later</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>export_slice_to_geotiff</span><span class=p>(</span><span class=n>ds</span><span class=p>,</span> <span class=n>path</span><span class=p>):</span> <span class=c1># Convert data to actual tiff file</span>
</span></span><span class=line><span class=cl>   <span class=n>write_geotiff_from_xr</span><span class=p>(</span><span class=n>path</span><span class=p>,</span><span class=n>ds</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>),</span><span class=nb>list</span><span class=p>(</span><span class=n>landsat</span><span class=o>.</span><span class=n>data_vars</span><span class=o>.</span><span class=n>keys</span><span class=p>()),</span><span class=n>crs</span><span class=o>=</span><span class=s2>&#34;EPSG:4326&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=c1># Cited write_geotiff_from_xr() function here, path is path and filename of new tiff file,</span>
</span></span><span class=line><span class=cl>   <span class=c1># ds.astype(np.float32) is converting integer values in original data to float values, probably because this function only accepts float,</span>
</span></span><span class=line><span class=cl>   <span class=c1># list(landsat.data_vars.keys()) is just converting all property values in here (nir, red, blue those) to list form</span>
</span></span><span class=line><span class=cl>   <span class=c1># Finally crs need not say due, can try how to read this data directly from original xarray.Dataset, manually input is really stupid</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#For each time slice in a dataset we call export_slice_to_geotif</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>export_xarray_to_geotiff</span><span class=p>(</span><span class=n>ds</span><span class=p>,</span> <span class=n>path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>ds</span><span class=o>.</span><span class=n>time</span><span class=p>:</span> <span class=c1># Then according to time data list in xarrayDataset.time grab out one by one to process</span>
</span></span><span class=line><span class=cl>       <span class=n>time_slice_xarray</span> <span class=o>=</span> <span class=n>ds</span><span class=o>.</span><span class=n>sel</span><span class=p>(</span><span class=n>time</span> <span class=o>=</span> <span class=n>t</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>       <span class=c1># First make a new xarray, then change time inside to single value (feels like pulling a slice from a layer), for conversion with write_geotiff_from_xr later</span>
</span></span><span class=line><span class=cl>       <span class=n>export_slice_to_geotiff</span><span class=p>(</span><span class=n>time_slice_xarray</span><span class=p>,</span> <span class=n>path</span> <span class=o>+</span> <span class=s2>&#34;_&#34;</span> <span class=o>+</span> <span class=n>time_to_string</span><span class=p>(</span><span class=n>t</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;.tif&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=c1># Then call export_slice_to_geotiff, actually is write_geotiff_from_xr() function</span>
</span></span><span class=line><span class=cl><span class=c1>#Start Export</span>
</span></span><span class=line><span class=cl><span class=n>output_dir</span> <span class=o>=</span> <span class=s2>&#34;/home/localuser/Datacube/data_cube_notebooks/NTUF_Hsing-Yu/ToTiffTest&#34;</span> <span class=c1># Path to save</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>output_dir</span><span class=p>):</span> <span class=c1># If folder exists directly save, if not create new one</span>
</span></span><span class=line><span class=cl>   <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=n>output_dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>export_xarray_to_geotiff</span><span class=p>(</span><span class=n>landsat</span><span class=p>,</span> <span class=s2>&#34;</span><span class=si>{}</span><span class=s2>/</span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>output_dir</span><span class=p>,</span><span class=n>product</span><span class=p>))</span> 
</span></span><span class=line><span class=cl><span class=c1># Usage of &#34;{}/{}&#34;.format(output_dir,product) haven&#39;t studied yet</span>
</span></span></code></pre></td></tr></table></div></div><ol start=6><li>Data plotting plot()
Under xarray.Dataset format can directly call plot() function to export image</li></ol><ul><li><strong>Example 1:</strong></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>autumn</span> <span class=o>=</span> <span class=n>nbar</span><span class=o>.</span><span class=n>green</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=s1>&#39;1991-3&#39;</span><span class=p>:</span><span class=s1>&#39;1991-5&#39;</span><span class=p>]</span> <span class=c1># For image seems can only plot single band, so here choose band you want</span>
</span></span><span class=line><span class=cl><span class=c1># Here chose green, then behind can set time interval, seems also can don&#39;t set!?</span>
</span></span><span class=line><span class=cl><span class=n>autumn</span><span class=o>.</span><span class=n>shape</span> <span class=c1># Check format</span>
</span></span><span class=line><span class=cl><span class=n>autumn</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>col</span><span class=o>=</span><span class=s1>&#39;time&#39;</span><span class=p>,</span> <span class=n>col_wrap</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span> <span class=c1># Then print graph, horizontal axis arranged by time, three per row</span>
</span></span><span class=line><span class=cl><span class=c1># Printed out like figure below</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/LiOMvUZ.png loading=lazy></p><ul><li><strong>Example 2: Remove nodata version:</strong></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>autumn_valid</span> <span class=o>=</span> <span class=n>autumn</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>autumn</span> <span class=o>!=</span> <span class=n>autumn</span><span class=o>.</span><span class=n>attrs</span><span class=p>[</span><span class=s1>&#39;nodata&#39;</span><span class=p>])</span> <span class=c1># Create new variable, used to store data with nodata removed</span>
</span></span><span class=line><span class=cl><span class=n>autumn_valid</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>col</span><span class=o>=</span><span class=s1>&#39;time&#39;</span><span class=p>,</span> <span class=n>col_wrap</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span> <span class=c1># Then output same</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/YZHQWlN.png loading=lazy></p><ul><li><strong>Example 3: Remove clouds</strong>
In Landsat 5 later satellite data will provide a pixelquality band, usually used to indicate cloud content of that pixel, there are few specific values indicating that pixel is usable, but I forgot</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>pq</span> <span class=o>=</span> <span class=n>dc</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>product</span><span class=o>=</span><span class=s1>&#39;ls5_pq_albers&#39;</span><span class=p>,</span> <span class=n>x</span><span class=o>=</span><span class=p>(</span><span class=mf>149.25</span><span class=p>,</span> <span class=mf>149.35</span><span class=p>),</span> <span class=n>y</span><span class=o>=</span><span class=p>(</span><span class=o>-</span><span class=mf>35.25</span><span class=p>,</span> <span class=o>-</span><span class=mf>35.35</span><span class=p>))</span> 
</span></span><span class=line><span class=cl><span class=c1># Same load first to make xarray.Dataset, note here loaded version is ls5_pq_albers, different from nbar version loaded before</span>
</span></span><span class=line><span class=cl><span class=n>pq_autumn</span> <span class=o>=</span> <span class=n>pq</span><span class=o>.</span><span class=n>pixelquality</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=s1>&#39;1991-3&#39;</span><span class=p>:</span><span class=s1>&#39;1991-5&#39;</span><span class=p>]</span> <span class=c1># Then same, just changed to plot with pixelquality band</span>
</span></span><span class=line><span class=cl><span class=n>pq_autumn</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>col</span><span class=o>=</span><span class=s1>&#39;time&#39;</span><span class=p>,</span> <span class=n>col_wrap</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span> <span class=c1># Displayed like below</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/aUUzZnB.png loading=lazy>
Can note special colors are pixels with higher cloud content, normally should be yellow, so later remove these colored blocks
Here will use masking tool, can take out from datacube.storage</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datacube.storage</span> <span class=kn>import</span> <span class=n>masking</span> <span class=c1># Take out masking tool</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span>
</span></span><span class=line><span class=cl><span class=n>pandas</span><span class=o>.</span><span class=n>DataFrame</span><span class=o>.</span><span class=n>from_dict</span><span class=p>(</span><span class=n>masking</span><span class=o>.</span><span class=n>get_flags_def</span><span class=p>(</span><span class=n>pq</span><span class=p>),</span> <span class=n>orient</span><span class=o>=</span><span class=s1>&#39;index&#39;</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=c1># masking.get_flags_def(pq) here is finding table how to judge pixelquality value from original xarray.Dataset</span>
</span></span><span class=line><span class=cl><span class=c1># Then will get a comparison table</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>good_data</span> <span class=o>=</span> <span class=n>masking</span><span class=o>.</span><span class=n>make_mask</span><span class=p>(</span><span class=n>pq</span><span class=p>,</span> <span class=n>cloud_acca</span><span class=o>=</span><span class=s1>&#39;no_cloud&#39;</span><span class=p>,</span> <span class=n>cloud_fmask</span><span class=o>=</span><span class=s1>&#39;no_cloud&#39;</span><span class=p>,</span> <span class=n>contiguous</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Next need to create a new mask, different color places on mask are places judged to have clouds</span>
</span></span><span class=line><span class=cl><span class=c1># According to table before, just need to set cloud_acca and cloud_fmask these two variables to &#39;no_cloud&#39;, and contiguous=True indicates this pixel still contains other bands,</span>
</span></span><span class=line><span class=cl><span class=c1># Can try set to false what happens</span>
</span></span><span class=line><span class=cl><span class=c1># Like this can make a mask</span>
</span></span><span class=line><span class=cl><span class=n>autumn_good_data</span> <span class=o>=</span> <span class=n>good_data</span><span class=o>.</span><span class=n>pixelquality</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=s1>&#39;1991-3&#39;</span><span class=p>:</span><span class=s1>&#39;1991-5&#39;</span><span class=p>]</span> <span class=c1># Then apply strictly to xarray.Dataset just now</span>
</span></span><span class=line><span class=cl><span class=n>autumn_good_data</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>col</span><span class=o>=</span><span class=s1>&#39;time&#39;</span><span class=p>,</span> <span class=n>col_wrap</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span> <span class=c1># Printed out as below</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/0o5VUvz.png loading=lazy>
Can discover, now either yellow or purple
Finally take to overlay with that picture with green band and processed nodata at beginning</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>autumn_cloud_free</span> <span class=o>=</span> <span class=n>autumn_valid</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>autumn_good_data</span><span class=p>)</span> <span class=c1># Same method as overlaying nodata</span>
</span></span><span class=line><span class=cl><span class=n>autumn_cloud_free</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>col</span><span class=o>=</span><span class=s1>&#39;time&#39;</span><span class=p>,</span> <span class=n>col_wrap</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span> <span class=c1># Printed out like below</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/4jtH7yl.png loading=lazy>
Can discover originally cloudy places became no data, because in mask, cloudy places numbers set to 0, no cloud places 1</p><p>Later discovered mask not effective, Landsat 8 data not quite usable, so I directly used where to take out data with pixel_qa as 322
Example:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>autumn</span> <span class=o>=</span> <span class=n>combined_dataset</span><span class=o>.</span><span class=n>green</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>combined_dataset</span><span class=o>.</span><span class=n>pixel_qa</span> <span class=o>==</span> <span class=mi>322</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Take data with value 322, this is best quality data in Landsat 8</span>
</span></span><span class=line><span class=cl><span class=n>autumn_valid</span> <span class=o>=</span> <span class=n>autumn</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>autumn</span> <span class=o>!=</span> <span class=n>autumn</span><span class=o>.</span><span class=n>attrs</span><span class=p>[</span><span class=s1>&#39;nodata&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=c1># Same clear nodata</span>
</span></span><span class=line><span class=cl><span class=n>autumn_valid</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>col</span><span class=o>=</span><span class=s1>&#39;time&#39;</span><span class=p>,</span> <span class=n>col_wrap</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Printed out like below (color not tuned very well XD)</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/jKdyrYy.png loading=lazy></p><ol start=7><li>Group plots (Super Important!!)
Sometimes due to satellite orbit, image of an area will be cut into two or three pictures, use Group can integrate close time pictures into one</li></ol><ul><li><strong>Example:</strong></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>nbar_by_solar_day</span> <span class=o>=</span> <span class=n>dc</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>product</span><span class=o>=</span><span class=s1>&#39;ls5_nbar_albers&#39;</span><span class=p>,</span> <span class=n>x</span><span class=o>=</span><span class=p>(</span><span class=mf>149.25</span><span class=p>,</span> <span class=mf>149.35</span><span class=p>),</span> <span class=n>y</span><span class=o>=</span><span class=p>(</span><span class=o>-</span><span class=mf>35.25</span><span class=p>,</span> <span class=o>-</span><span class=mf>35.35</span><span class=p>),</span> <span class=n>group_by</span><span class=o>=</span><span class=s1>&#39;solar_day&#39;</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=c1># Mostly same as using load() before, just added group_by=&#39;solar_day&#39; at end to group pictures by solar day range</span>
</span></span><span class=line><span class=cl><span class=nb>len</span><span class=p>(</span><span class=n>nbar_by_solar_day</span><span class=o>.</span><span class=n>time</span><span class=p>)</span> <span class=c1># See if pictures really reduced</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>autumn2</span> <span class=o>=</span> <span class=n>nbar_by_solar_day</span><span class=o>.</span><span class=n>green</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=s1>&#39;1991-3&#39;</span><span class=p>:</span><span class=s1>&#39;1991-5&#39;</span><span class=p>]</span> <span class=c1># Same take out green band to plot</span>
</span></span><span class=line><span class=cl><span class=n>autumn2</span><span class=o>.</span><span class=n>shape</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>autumn2</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>col</span><span class=o>=</span><span class=s1>&#39;time&#39;</span><span class=p>,</span> <span class=n>col_wrap</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span> <span class=c1># Same draw graph, becomes like below</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/XJzQQ6L.png loading=lazy>
Can discover originally cut parts disappeared!!!</p><ol><li>Calculate ndvi
Just use red and nir these two bands to calculate ndvi, probably can reflect if ground object is plant
red is red light, nir is near infrared light</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>two_bands</span> <span class=o>=</span> <span class=n>dc</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>product</span><span class=o>=</span><span class=s1>&#39;ls5_nbar_albers&#39;</span><span class=p>,</span> <span class=n>x</span><span class=o>=</span><span class=p>(</span><span class=mf>149.07</span><span class=p>,</span> <span class=mf>149.17</span><span class=p>),</span> <span class=n>y</span><span class=o>=</span><span class=p>(</span><span class=o>-</span><span class=mf>35.25</span><span class=p>,</span> <span class=o>-</span><span class=mf>35.35</span><span class=p>),</span> <span class=n>time</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;1991&#39;</span><span class=p>,</span> <span class=s1>&#39;1992&#39;</span><span class=p>),</span> <span class=n>measurements</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=s1>&#39;nir&#39;</span><span class=p>],</span> <span class=n>group_by</span><span class=o>=</span><span class=s1>&#39;solar_day&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Same as load() usage before, but this time use measurements, simultaneous only load &#39;red&#39;, &#39;nir&#39; two bands, same remember to use group_by</span>
</span></span><span class=line><span class=cl><span class=n>red</span> <span class=o>=</span> <span class=n>two_bands</span><span class=o>.</span><span class=n>red</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>two_bands</span><span class=o>.</span><span class=n>red</span> <span class=o>!=</span> <span class=n>two_bands</span><span class=o>.</span><span class=n>red</span><span class=o>.</span><span class=n>attrs</span><span class=p>[</span><span class=s1>&#39;nodata&#39;</span><span class=p>])</span> <span class=c1># Then remove nodata</span>
</span></span><span class=line><span class=cl><span class=n>nir</span> <span class=o>=</span> <span class=n>two_bands</span><span class=o>.</span><span class=n>nir</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>two_bands</span><span class=o>.</span><span class=n>nir</span> <span class=o>!=</span> <span class=n>two_bands</span><span class=o>.</span><span class=n>nir</span><span class=o>.</span><span class=n>attrs</span><span class=p>[</span><span class=s1>&#39;nodata&#39;</span><span class=p>])</span> <span class=c1># Also remove nodata</span>
</span></span><span class=line><span class=cl><span class=n>pq</span> <span class=o>=</span> <span class=n>dc</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>product</span><span class=o>=</span><span class=s1>&#39;ls5_pq_albers&#39;</span><span class=p>,</span> <span class=n>x</span><span class=o>=</span><span class=p>(</span><span class=mf>149.07</span><span class=p>,</span> <span class=mf>149.17</span><span class=p>),</span> <span class=n>y</span><span class=o>=</span><span class=p>(</span><span class=o>-</span><span class=mf>35.25</span><span class=p>,</span> <span class=o>-</span><span class=mf>35.35</span><span class=p>),</span> <span class=n>time</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;1991&#39;</span><span class=p>,</span> <span class=s1>&#39;1992&#39;</span><span class=p>),</span> <span class=n>group_by</span><span class=o>=</span><span class=s1>&#39;solar_day&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Then load another map (is pq version), later use to make cloud free mask</span>
</span></span><span class=line><span class=cl><span class=n>cloud_free</span> <span class=o>=</span> <span class=n>masking</span><span class=o>.</span><span class=n>make_mask</span><span class=p>(</span><span class=n>pq</span><span class=p>,</span> <span class=n>cloud_acca</span><span class=o>=</span><span class=s1>&#39;no_cloud&#39;</span><span class=p>,</span> <span class=n>cloud_fmask</span><span class=o>=</span><span class=s1>&#39;no_cloud&#39;</span><span class=p>,</span> <span class=n>contiguous</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span><span class=o>.</span><span class=n>pixelquality</span>
</span></span><span class=line><span class=cl><span class=c1># Use previous map to make a mask, same take out pixelquality part</span>
</span></span><span class=line><span class=cl><span class=n>ndvi</span> <span class=o>=</span> <span class=p>((</span><span class=n>nir</span> <span class=o>-</span> <span class=n>red</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>nir</span> <span class=o>+</span> <span class=n>red</span><span class=p>))</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>cloud_free</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Take nir and red two maps calculate ndvi, then overlay with cloud_free, remove cloud parts</span>
</span></span><span class=line><span class=cl><span class=n>ndvi</span><span class=o>.</span><span class=n>shape</span> <span class=c1># Check data amount</span>
</span></span><span class=line><span class=cl><span class=n>ndvi</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>col</span><span class=o>=</span><span class=s1>&#39;time&#39;</span><span class=p>,</span> <span class=n>col_wrap</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span> <span class=c1># Print out, like below</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/SsOBuDA.png loading=lazy>
Actually still many places cut off XD, and image quality uneven, next can take out few pictures with better image quality, that is less cloud content</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>mostly_cloud_free</span> <span class=o>=</span> <span class=n>cloud_free</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>dim</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;x&#39;</span><span class=p>,</span><span class=s1>&#39;y&#39;</span><span class=p>))</span> <span class=o>&gt;</span> <span class=p>(</span><span class=mf>0.75</span> <span class=o>*</span> <span class=n>cloud_free</span><span class=o>.</span><span class=n>size</span> <span class=o>/</span> <span class=n>cloud_free</span><span class=o>.</span><span class=n>time</span><span class=o>.</span><span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Simply put find pictures with least 25% cloud content</span>
</span></span><span class=line><span class=cl><span class=n>mostly_good_ndvi</span> <span class=o>=</span> <span class=n>ndvi</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>mostly_cloud_free</span><span class=p>)</span><span class=o>.</span><span class=n>dropna</span><span class=p>(</span><span class=s1>&#39;time&#39;</span><span class=p>,</span> <span class=n>how</span><span class=o>=</span><span class=s1>&#39;all&#39;</span><span class=p>)</span> <span class=c1># Then overlay with original, delete cloudy pictures</span>
</span></span><span class=line><span class=cl><span class=n>mostly_good_ndvi</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>col</span><span class=o>=</span><span class=s1>&#39;time&#39;</span><span class=p>,</span> <span class=n>col_wrap</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span> <span class=c1># Print out</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/biR5vE2.png loading=lazy>
Discover only clear pictures left
Below is ndvi I calculated using previous Taoyuan City data</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>red</span> <span class=o>=</span> <span class=n>combined_dataset</span><span class=o>.</span><span class=n>red</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>combined_dataset</span><span class=o>.</span><span class=n>red</span> <span class=o>!=</span> <span class=n>combined_dataset</span><span class=o>.</span><span class=n>red</span><span class=o>.</span><span class=n>attrs</span><span class=p>[</span><span class=s1>&#39;nodata&#39;</span><span class=p>])</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>combined_dataset</span><span class=o>.</span><span class=n>pixel_qa</span> <span class=o>==</span> <span class=mi>322</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>nir</span> <span class=o>=</span> <span class=n>combined_dataset</span><span class=o>.</span><span class=n>nir</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>combined_dataset</span><span class=o>.</span><span class=n>nir</span> <span class=o>!=</span> <span class=n>combined_dataset</span><span class=o>.</span><span class=n>nir</span><span class=o>.</span><span class=n>attrs</span><span class=p>[</span><span class=s1>&#39;nodata&#39;</span><span class=p>])</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>combined_dataset</span><span class=o>.</span><span class=n>pixel_qa</span> <span class=o>==</span> <span class=mi>322</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Similar to above, take out red and nir two bands, then use where take out places with pixel_qa as 322</span>
</span></span><span class=line><span class=cl><span class=n>ndvi</span> <span class=o>=</span> <span class=p>((</span><span class=n>nir</span> <span class=o>-</span> <span class=n>red</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>nir</span> <span class=o>+</span> <span class=n>red</span><span class=p>))</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>ndvi</span> <span class=o>&lt;=</span> <span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>ndvi</span> <span class=o>&gt;=</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Apply ndvi formula</span>
</span></span><span class=line><span class=cl><span class=n>ndvi</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl><span class=n>ndvi</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>col</span><span class=o>=</span><span class=s1>&#39;time&#39;</span><span class=p>,</span> <span class=n>col_wrap</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Print out</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/qAhJJWt.jpg loading=lazy>
Next pick pictures with less clouds</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>cloud_free</span> <span class=o>=</span> <span class=n>combined_dataset</span><span class=o>.</span><span class=n>pixel_qa</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>combined_dataset</span><span class=o>.</span><span class=n>pixel_qa</span> <span class=o>!=</span>     <span class=n>combined_dataset</span><span class=o>.</span><span class=n>pixel_qa</span><span class=o>.</span><span class=n>attrs</span><span class=p>[</span><span class=s1>&#39;nodata&#39;</span><span class=p>])</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>combined_dataset</span><span class=o>.</span><span class=n>pixel_qa</span> <span class=o>==</span> <span class=mi>322</span><span class=p>)</span> <span class=o>/</span> <span class=mi>322</span>
</span></span><span class=line><span class=cl><span class=c1># Here use previous pixel_qa map, grab value 322 part, rescale to 1, fake a mask</span>
</span></span><span class=line><span class=cl><span class=c1>#cloud_free.plot(col=&#39;time&#39;, col_wrap=3)</span>
</span></span><span class=line><span class=cl><span class=n>mostly_cloud_free</span> <span class=o>=</span> <span class=n>cloud_free</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>dim</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;latitude&#39;</span><span class=p>,</span><span class=s1>&#39;longitude&#39;</span><span class=p>))</span> <span class=o>&gt;</span> <span class=p>(</span><span class=mf>0.75</span> <span class=o>*</span> <span class=n>cloud_free</span><span class=o>.</span><span class=n>size</span> <span class=o>/</span> <span class=n>cloud_free</span><span class=o>.</span><span class=n>time</span><span class=o>.</span><span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Then calculate proportion of non-cloud data inside, actually just sum it up</span>
</span></span><span class=line><span class=cl><span class=n>mostly_good_ndvi</span> <span class=o>=</span> <span class=n>ndvi</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>mostly_cloud_free</span><span class=p>)</span><span class=o>.</span><span class=n>dropna</span><span class=p>(</span><span class=s1>&#39;time&#39;</span><span class=p>,</span> <span class=n>how</span><span class=o>=</span><span class=s1>&#39;all&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Then overlay map</span>
</span></span><span class=line><span class=cl><span class=n>mostly_good_ndvi</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>col</span><span class=o>=</span><span class=s1>&#39;time&#39;</span><span class=p>,</span> <span class=n>col_wrap</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Print out</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/ilufKDH.png loading=lazy>
First picture estimate system mistake, all clouds, but value is 322, just bear with it
Next ndvi can also form a median map, somewhat similar to concept of average, can see large range complete appearance, not affected by missing picture</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>mostly_good_ndvi</span><span class=o>.</span><span class=n>median</span><span class=p>(</span><span class=n>dim</span><span class=o>=</span><span class=s1>&#39;time&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># Just take median of each pixel, form a map, this function quite amazing</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/sIwU3Hr.png loading=lazy>
Printed out like this, darker places probably no plants haha
p.s. Why not use average? Because average will be affected by nodata
Then can also make a std map, indicating degree of change</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>mostly_good_ndvi</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>dim</span><span class=o>=</span><span class=s1>&#39;time&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># Concept similar to median just now</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/7Nl2H8e.png loading=lazy>
Lighter color places are places with larger change, ndvi changes with season, everyone knows this, so same, bright places are places with plants</p><p>Then can also grab single point ndvi change, so I randomly picked a point using google map
Cite sel function, input parameter behind, can read value of that coordinate at each time</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>mostly_good_ndvi</span><span class=o>.</span><span class=n>sel</span><span class=p>(</span><span class=n>latitude</span><span class=o>=</span><span class=mf>24.958132</span><span class=p>,</span> <span class=n>longitude</span><span class=o>=</span><span class=mf>121.126085</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;nearest&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/Out4BAu.png loading=lazy>
Drawn graph, to some extent still affected by nodata</p><p>Below is weird usage of example, seems like grabbing ndvi trend, detailed mechanism need study again</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>mostly_good_ndvi</span><span class=o>.</span><span class=n>isel</span><span class=p>(</span><span class=n>latitude</span><span class=o>=</span><span class=p>[</span><span class=mi>200</span><span class=p>],</span> <span class=n>longitude</span><span class=o>=</span><span class=p>[</span><span class=mi>200</span><span class=p>])</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># That two hundred I don&#39;t know for what, I tried other values, but graphs came out weird</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/0iFxSwE.png loading=lazy>
This graph can clearly see seasonal change of ndvi</p><p>Next is also weird usage of example, can fix latitude, list situation of different times</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>mostly_good_ndvi</span><span class=o>.</span><span class=n>isel</span><span class=p>(</span><span class=n>longitude</span><span class=o>=</span><span class=mi>30</span><span class=p>)</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># Meaning of 30 seems to represent 30th pixel of longitude</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/bug1KLd.png loading=lazy>
Comparison like this really can see obvious seasonal change</p><p>In addition can also grab specific points to compare influence of time</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>mostly_good_ndvi</span><span class=o>.</span><span class=n>isel_points</span><span class=p>(</span><span class=n>latitude</span><span class=o>=</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>40</span><span class=p>,</span> <span class=mi>50</span><span class=p>],</span> <span class=n>longitude</span><span class=o>=</span><span class=p>[</span><span class=mi>20</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>40</span><span class=p>,</span> <span class=mi>50</span><span class=p>,</span> <span class=mi>60</span><span class=p>,</span> <span class=mi>70</span><span class=p>])</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>x</span><span class=o>=</span><span class=s1>&#39;points&#39;</span><span class=p>,</span> <span class=n>y</span><span class=o>=</span><span class=s1>&#39;time&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Same as above those values also which point in terms of coordinates</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/oEY66gD.png loading=lazy></p><ol start=9><li>Multispectral mapping (not made into tif)
After playing long time still want to make a color map to self-satisfy
Method below works</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>rgb</span> <span class=o>=</span> <span class=n>dc</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>product</span><span class=o>=</span><span class=n>product</span><span class=p>,</span> <span class=n>lon</span><span class=o>=</span><span class=n>lon</span><span class=p>,</span> <span class=n>lat</span><span class=o>=</span><span class=n>lat</span><span class=p>,</span> <span class=n>time</span><span class=o>=</span><span class=n>date_range</span><span class=p>,</span> <span class=n>measurements</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=s1>&#39;blue&#39;</span><span class=p>],</span> <span class=n>group_by</span><span class=o>=</span><span class=s1>&#39;solar_day&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>to_array</span><span class=p>(</span><span class=n>dim</span><span class=o>=</span><span class=s1>&#39;color&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=s1>&#39;time&#39;</span><span class=p>,</span> <span class=s1>&#39;latitude&#39;</span><span class=p>,</span> <span class=s1>&#39;longitude&#39;</span><span class=p>,</span> <span class=s1>&#39;color&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Done many times before, won&#39;t repeat, red green blue bands must load, don&#39;t know what happens if load other bands, try when free</span>
</span></span><span class=line><span class=cl><span class=c1># Behind is create a dim for new color</span>
</span></span><span class=line><span class=cl><span class=nb>zip</span><span class=p>(</span><span class=n>rgb</span><span class=o>.</span><span class=n>dims</span><span class=p>,</span> <span class=n>rgb</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Doing this zip or not actually doesn&#39;t matter</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>fake_saturation</span> <span class=o>=</span> <span class=mi>3000</span>
</span></span><span class=line><span class=cl><span class=c1># This is used as upper limit of image value, exceed then replace with 3000</span>
</span></span><span class=line><span class=cl><span class=n>clipped_visible</span> <span class=o>=</span> <span class=n>rgb</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>rgb</span> <span class=o>&lt;</span> <span class=n>fake_saturation</span><span class=p>)</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=n>fake_saturation</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Above here do like this, thorough fillna() function can fill in value</span>
</span></span><span class=line><span class=cl><span class=n>max_val</span> <span class=o>=</span> <span class=n>clipped_visible</span><span class=o>.</span><span class=n>max</span><span class=p>([</span><span class=s1>&#39;latitude&#39;</span><span class=p>,</span> <span class=s1>&#39;longitude&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=c1># Then find largest scale</span>
</span></span><span class=line><span class=cl><span class=n>scaled</span> <span class=o>=</span> <span class=p>(</span><span class=n>clipped_visible</span> <span class=o>/</span> <span class=n>max_val</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Set scaled</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>matplotlib</span> <span class=kn>import</span> <span class=n>pyplot</span> <span class=k>as</span> <span class=n>plt</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>scaled</span><span class=o>.</span><span class=n>isel</span><span class=p>(</span><span class=n>time</span><span class=o>=</span><span class=mi>19</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># Finally print out, remember to import things needed</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/ziPdkS2.png loading=lazy>
Picked one less covered by clouds</p><ol start=10><li><p>Convert xarray.Dataarray to Dataset
<a class=link href=http://xarray.pydata.org/en/stable/generated/xarray.DataArray.to_dataset.html target=_blank rel=noopener>http://xarray.pydata.org/en/stable/generated/xarray.DataArray.to_dataset.html</a>
<a class=link href=https://stackoverflow.com/questions/38826505/python-xarray-add-dataarray-to-dataset target=_blank rel=noopener>https://stackoverflow.com/questions/38826505/python-xarray-add-dataarray-to-dataset</a></p></li><li><p>Data type conversion in Dataarray or Dataset
<a class=link href=http://xarray.pydata.org/en/stable/generated/xarray.DataArray.astype.html target=_blank rel=noopener>http://xarray.pydata.org/en/stable/generated/xarray.DataArray.astype.html</a></p></li><li><p>Alternative .get() for not wanting to use .variables
<a class=link href=https://github.com/pydata/xarray/issues/1801 target=_blank rel=noopener>https://github.com/pydata/xarray/issues/1801</a></p></li><li><p>Export thing drawn by matplotlib to png
<a class=link href=https://stackoverflow.com/questions/9622163/save-plot-to-image-file-instead-of-displaying-it-using-matplotlib target=_blank rel=noopener>https://stackoverflow.com/questions/9622163/save-plot-to-image-file-instead-of-displaying-it-using-matplotlib</a></p></li></ol><h1 id=datacube-function-note---advanced>Datacube Function Note - Advanced</h1><ul><li>WOFs</li></ul><h1 id=datacube-function-note---others>Datacube Function Note - Others</h1><ul><li>File Unzip
Under condition that server Shell can be used, usually upload file after packing (.zip) then use unzip under Linux to decompress, but new Jupyter interface turned off Shell function, so can only use python built-in library to decompress, program as follows:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span><span class=o>,</span><span class=nn>zipfile</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>un_zip</span><span class=p>(</span><span class=n>file_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;unzip zip file&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>zip_file</span> <span class=o>=</span> <span class=n>zipfile</span><span class=o>.</span><span class=n>ZipFile</span><span class=p>(</span><span class=n>file_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>isdir</span><span class=p>(</span><span class=n>file_name</span> <span class=o>+</span> <span class=s2>&#34;_files&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>file_name</span> <span class=o>+</span> <span class=s2>&#34;_files&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>names</span> <span class=ow>in</span> <span class=n>zip_file</span><span class=o>.</span><span class=n>namelist</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>zip_file</span><span class=o>.</span><span class=n>extract</span><span class=p>(</span><span class=n>names</span><span class=p>,</span><span class=n>file_name</span> <span class=o>+</span> <span class=s2>&#34;_files/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>zip_file</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>un_zip</span><span class=p>(</span><span class=s2>&#34;utils.zip&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Usage: First use % command switch to correct working directory, then start run program above</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span><span class=o>,</span> <span class=nn>zipfile</span>
</span></span><span class=line><span class=cl><span class=c1># Pack directory as zip file (uncompressed)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_zip</span><span class=p>(</span><span class=n>source_dir</span><span class=p>,</span> <span class=n>output_filename</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>zipf</span> <span class=o>=</span> <span class=n>zipfile</span><span class=o>.</span><span class=n>ZipFile</span><span class=p>(</span><span class=n>output_filename</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pre_len</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>source_dir</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>parent</span><span class=p>,</span> <span class=n>dirnames</span><span class=p>,</span> <span class=n>filenames</span> <span class=ow>in</span> <span class=n>os</span><span class=o>.</span><span class=n>walk</span><span class=p>(</span><span class=n>source_dir</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>filename</span> <span class=ow>in</span> <span class=n>filenames</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>pathfile</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>parent</span><span class=p>,</span> <span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>arcname</span> <span class=o>=</span> <span class=n>pathfile</span><span class=p>[</span><span class=n>pre_len</span><span class=p>:]</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>sep</span><span class=p>)</span>   <span class=c1># Relative path</span>
</span></span><span class=line><span class=cl>            <span class=n>zipf</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>pathfile</span><span class=p>,</span> <span class=n>arcname</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>zipf</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>make_zip</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;E:\python_sample\libs\test_tar_files\libs&#34;</span><span class=p>,</span><span class=s2>&#34;test.zip&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Jupyter Use Terminal Commands
Although shell usage terminated, but can still use Linux commands in Jupyter, but subject to permission limits
ex:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>% ls
</span></span><span class=line><span class=cl>% <span class=nb>cd</span> ~
</span></span><span class=line><span class=cl>% <span class=nb>pwd</span>
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=/tags/datacube/>Datacube</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2019 -
2025 Hsing-Yu Shih</section><section class=powerby></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>