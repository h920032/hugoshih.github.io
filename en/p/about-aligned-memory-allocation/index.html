<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="About Aligned Memory Allocation"><title>About Aligned Memory Allocation</title><link rel=canonical href=https://www.hugoshih.com/en/p/about-aligned-memory-allocation/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="About Aligned Memory Allocation"><meta property='og:description' content="About Aligned Memory Allocation"><meta property='og:url' content='https://www.hugoshih.com/en/p/about-aligned-memory-allocation/'><meta property='og:site_name' content='Hsing-Yu Shih'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Linux'><meta property='article:tag' content='Clang'><meta property='article:tag' content='Interview'><meta property='article:tag' content='Embedded'><meta property='article:published_time' content='2025-10-30T21:48:32+08:00'><meta property='article:modified_time' content='2025-10-30T21:48:32+08:00'><meta property='og:image' content='https://i.imgur.com/WVmjgMd.jpeg'><meta name=twitter:title content="About Aligned Memory Allocation"><meta name=twitter:description content="About Aligned Memory Allocation"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://i.imgur.com/WVmjgMd.jpeg'><link rel="shortcut icon" href=/img/favicon.png><script async src="https://www.googletagmanager.com/gtag/js?id=G-6PQF6N4WXG"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6PQF6N4WXG")}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.setItem(e,"dark")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/en/><img src=/img/avatar_hu_819cc45341d19fd1.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/en>Hsing-Yu Shih</a></h1><h2 class=site-description>Chase excellence, success will follow you.</h2></div></header><ol class=menu-social><li><a href=https://github.com/h920032 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/hugoshih/ target=_blank title=Linkedin rel=me><svg class="icon icon-tabler icon-tabler-brand-linkedin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><desc>Download more icon variants from https://tabler-icons.io/i/brand-linkedin</desc><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="4" width="16" height="16" rx="2"/><line x1="8" y1="11" x2="8" y2="16"/><line x1="8" y1="8" x2="8" y2="8.01"/><line x1="12" y1="16" x2="12" y2="11"/><path d="M16 16v-3a2 2 0 00-4 0"/></svg></a></li><li><a href=https://orcid.org/0000-0003-4111-3768 target=_blank title=Research rel=me><svg class="icon icon-tabler icon-tabler-school" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><desc>Download more icon variants from https://tabler-icons.io/i/school</desc><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 9 12 5 2 9l10 4 10-4v6"/><path d="M6 10.6V16a6 3 0 0012 0v-5.4"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/en/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/en/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/en/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/en/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://www.hugoshih.com/en/ selected>English</option><option value=https://www.hugoshih.com/>中文</option></select></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#origin>Origin</a></li><li><a href=#what-is-aligned-memory-allocation>What is Aligned Memory Allocation?</a></li><li><a href=#why-is-alignment-needed>Why is Alignment Needed?</a></li><li><a href=#so-how-to-achieve-alignment>So how to achieve Alignment?</a></li><li><a href=#c-implementation>C Implementation</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#reference>Reference</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/en/p/about-aligned-memory-allocation/><img src=https://i.imgur.com/WVmjgMd.jpeg loading=lazy alt="Featured image of post About Aligned Memory Allocation"></a></div><div class=article-details><header class=article-category><a href=/en/categories/embedded/>Embedded</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/en/p/about-aligned-memory-allocation/>About Aligned Memory Allocation</a></h2><h3 class=article-subtitle>About Aligned Memory Allocation</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-10-30T21:48:32+08:00>Oct 30, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>6 minute read</time></div></footer><footer class=article-translations><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><div><a href=https://www.hugoshih.com/p/%E9%97%9C%E6%96%BC-aligned-memory-allocation/ class=link>中文</a></div></footer></div></header><section class=article-content><h2 id=origin>Origin</h2><p>I suffered a big loss on this thing. As for what the loss was, I won&rsquo;t go into details. In short, when I first saw this thing, I didn&rsquo;t understand it thoroughly, so I&rsquo;m taking this opportunity to pay off my debt.
I want to use a super plain way to make people understand quickly, so next time I encounter this issue, I can quickly recall it.</p><h2 id=what-is-aligned-memory-allocation>What is Aligned Memory Allocation?</h2><p>Imagine a situation where the program runs to a point where I need some extra memory to store new data. In C language, we will definitely use <code>malloc()</code> to ask the system for extra memory space.</p><p>For example, I suddenly need 32 bytes of space, so I use <code>malloc()</code>, and then the system looks around and finally finds 32 bytes of space in the memory and returns the starting memory address. This starting position might be very random, like <code>0x08004321</code>, but it doesn&rsquo;t matter. Anyway, I now have 32 bytes of space, and I can do whatever I want with it.</p><p>However, in some cases (I&rsquo;ll talk about which cases later), we would hope that the starting position of the memory we get is &ldquo;aligned&rdquo;. So what is alignment?</p><p>For example, if you use some Hex file preview tools, you will see that the starting position on the left is neatly arranged at 32 bytes intervals, like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>General Random Allocation (Unaligned):
</span></span><span class=line><span class=cl>0x08004321  |  Data...
</span></span><span class=line><span class=cl>            ^ Starting position is random
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>32-byte Alignment (Aligned):
</span></span><span class=line><span class=cl>0x08000000  |  Data...
</span></span><span class=line><span class=cl>0x08000020  |  Data...  &lt;-- 0x20 is 32
</span></span><span class=line><span class=cl>0x08000040  |  Data...  &lt;-- 0x40 is 64
</span></span><span class=line><span class=cl>            ^ Starting positions are all divisible by 32
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/hr8QdrG.jpeg loading=lazy alt=image></p><p>So-called <strong>Aligned Memory Allocation</strong> means that when I ask for new memory space, I want to get a <strong>memory space whose starting position can be divisible by 32 (or other numbers)</strong>.</p><p>OK, so up to this point, you should have some concept of what Aligned Memory Allocation is. That&rsquo;s half the battle. Because most people hearing about this for the first time probably find it hard to imagine what it is, or know what it is but don&rsquo;t know what it&rsquo;s used for.</p><p>So, what is the use of this?</p><h2 id=why-is-alignment-needed>Why is Alignment Needed?</h2><p>The need for Alignment is mostly due to hardware design constraints, for example:</p><p>Vector instruction sets (such as AVX), when executing such instruction sets, will require the target memory position to be aligned. If it is not aligned, it has to be split into two steps to handle, or an error will occur directly. Why not design the instruction set to read memory starting from any position? I think it&rsquo;s mostly a cost consideration. If it can be solved on the driver side, why waste expensive hardware space?</p><p>Others like CUDA, when fetching data via PCIe on GPU, using DMA will also require memory to be aligned. Or when GPU instructions fetch data from its own memory, it will also require alignment. In addition, when using DMA on single chips like STM32, the memory position of the buffer will also be required to be aligned so that it can be correctly written or read by DMA.</p><p>At this time, someone will definitely jump out and say: &ldquo;I usually use CUDA or use DMA on STM32 and haven&rsquo;t encountered this problem!&rdquo;</p><p>That&rsquo;s because the CUDA driver or HAL library etc. will handle it for you, so of course you don&rsquo;t feel it. Conversely, if you are writing a driver or doing bare metal development today, you must be careful about memory alignment, otherwise it might not even move.</p><h2 id=so-how-to-achieve-alignment>So how to achieve Alignment?</h2><p>Having said so much, how can we achieve Alignment during memory allocation?</p><p>Imagine that our goal today is to get a new 64 bytes memory, and require 32-byte alignment.
If the starting position given by <code>malloc</code> today happens to be <code>0x08000040</code>, which is the starting position of an alignment block, then we hit the jackpot, but in reality, we are certainly not that lucky. The starting position it gives you might be <code>0x08000041</code> (offset by 1 byte), or it might be <code>0x0800005F</code> (offset by 31 bytes).</p><p>But it doesn&rsquo;t matter. At this time, we will think that as long as the memory <code>malloc</code>&rsquo;d is long enough, finding the starting point of an Alignment Block from it and starting to store data from there, that also counts as alignment.</p><p>So the question returns to, how long memory should we ask for?
Observing the previous example, if doing 32 bytes alignment, the offset amount is at most <code>0 ~ 31</code> bytes. So the space we want to <code>malloc()</code> must be at least <code>size + alignment - 1</code>.</p><p>Wait, something seems missing?
If so, how can we <code>free</code> those spaces before the alignment starting address? We need to record <strong>the starting address originally <code>malloc</code>&rsquo;d</strong>, so we need one more position to store this pointer. This required space is <code>sizeof(void*)</code>.</p><p>In summary, the length we really want to <code>malloc()</code> is:
<code>size + alignment - 1 + sizeof(void*)</code></p><p><strong>Memory Structure Diagram:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Actual malloc&#39;d block (Original)
</span></span><span class=line><span class=cl>|
</span></span><span class=line><span class=cl>v
</span></span><span class=line><span class=cl>+-------------+---------------------+-------------------------+
</span></span><span class=line><span class=cl>| padding ... | Original Pointer    | User Pointer (Aligned)  |
</span></span><span class=line><span class=cl>|             | (Stored)            |                         |
</span></span><span class=line><span class=cl>+-------------+---------------------+-------------------------+
</span></span><span class=line><span class=cl>              ^                     ^
</span></span><span class=line><span class=cl>              |                     |
</span></span><span class=line><span class=cl>              This slot stores      Fits 32-byte alignment
</span></span><span class=line><span class=cl>              original address      We return this address
</span></span></code></pre></td></tr></table></div></div><p>Then we just need to find the alignment starting address inside, and store the &ldquo;original starting address&rdquo; in the slot before the alignment start. This way, when <code>free</code>ing memory, just look <strong>one slot backward</strong> from the alignment address, and we can find the memory starting point we should free.</p><p>The principle concept is just like this. So let&rsquo;s see how to implement it.</p><h2 id=c-implementation>C Implementation</h2><p>The following takes 32-byte alignment as an example. You can change 32 to any positive integer alignment you want (usually a power of 2).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdint.h&gt; // for uintptr_t</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span><span class=o>*</span> <span class=nf>aligned_malloc</span><span class=p>(</span><span class=kt>size_t</span> <span class=n>size</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 1. Calculate the total space needed:
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//    size + adjustment space of (alignment - 1) + space to store original pointer
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>void</span> <span class=o>*</span><span class=n>original</span> <span class=o>=</span> <span class=nf>malloc</span><span class=p>(</span><span class=n>size</span> <span class=o>+</span> <span class=mi>32</span> <span class=o>-</span> <span class=mi>1</span> <span class=o>+</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>original</span><span class=p>)</span> <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 2. Calculate the alignment starting position
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//    First reserve a pointer space for us to store the address
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>uintptr_t</span> <span class=n>raw</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uintptr_t</span><span class=p>)</span><span class=n>original</span> <span class=o>+</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>//    Use Bitwise operation for alignment
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//    Principle: (address + mask) &amp; ~mask
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//    Note: Here use ~(32 - 1) i.e. ~31 to mask off the last five bits to achieve 32 alignment
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>uintptr_t</span> <span class=n>aligned</span> <span class=o>=</span> <span class=p>(</span><span class=n>raw</span> <span class=o>+</span> <span class=p>(</span><span class=mi>32</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span> <span class=o>&amp;</span> <span class=o>~</span><span class=p>(</span><span class=mi>32</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>//    Actually can also use (void*)(original - (original % 32)); to calculate
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//    Just that using bit manipulation feels more elegant
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// 3. Store the original malloc() starting address in the slot before the alignment address
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>((</span><span class=kt>void</span><span class=o>**</span><span class=p>)</span><span class=n>aligned</span><span class=p>)[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>original</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 4. Finally return the alignment start
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>aligned</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>aligned_free</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>ptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>ptr</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// When freeing, find the original malloc address stored one slot before the alignment address
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>void</span> <span class=o>*</span><span class=n>original</span> <span class=o>=</span> <span class=p>((</span><span class=kt>void</span><span class=o>**</span><span class=p>)</span><span class=n>ptr</span><span class=p>)[</span><span class=o>-</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Then just free it
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>free</span><span class=p>(</span><span class=n>original</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=conclusion>Conclusion</h2><p>Anyway, that&rsquo;s it. Aligned Memory Allocation is important and has some implementation details. Taking this opportunity, I have figured it out. Even if I forget it in the future, I can quickly come back to review it.</p><h2 id=reference>Reference</h2><ul><li><a class=link href=https://bclin.tw/2020/03/15/aligned-malloc/ target=_blank rel=noopener>How to implement an aligned_alloc () ?</a></li><li><a class=link href=https://medium.com/howsofcoding/memory-management-aligned-malloc-and-free-9273336bd4c6 target=_blank rel=noopener>Designing aligned Memory Allocator</a></li><li><a class=link href=https://linux.die.net/man/3/aligned_alloc target=_blank rel=noopener>aligned_alloc(3) - Linux man page</a></li></ul></section><footer class=article-footer><section class=article-tags><a href=/en/tags/linux/>Linux</a>
<a href=/en/tags/clang/>Clang</a>
<a href=/en/tags/interview/>Interview</a>
<a href=/en/tags/embedded/>Embedded</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/en/p/introduction-and-comparison-of-common-real-time-os/><div class=article-image><img src=https://i.imgur.com/7SJYZ3b.jpg loading=lazy data-key data-hash=https://i.imgur.com/7SJYZ3b.jpg></div><div class=article-details><h2 class=article-title>Introduction and Comparison of Common Real-Time OS</h2></div></a></article><article class=has-image><a href=/en/p/two-ways-to-create-threads-in-zephyr-rtos/><div class=article-image><img src=https://i.imgur.com/V5OSNcL.jpg loading=lazy data-key data-hash=https://i.imgur.com/V5OSNcL.jpg></div><div class=article-details><h2 class=article-title>Two Ways to Create Threads in Zephyr RTOS</h2></div></a></article><article class=has-image><a href=/en/p/common-mcus-in-embedded-systems/><div class=article-image><img src=https://i.imgur.com/xEqWwbo.jpg loading=lazy data-key data-hash=https://i.imgur.com/xEqWwbo.jpg></div><div class=article-details><h2 class=article-title>Common MCUs in Embedded Systems</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2019 -
2025 Hsing-Yu Shih</section><section class=powerby></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>